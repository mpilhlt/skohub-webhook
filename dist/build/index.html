<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>SkoHub-Log</title>
    <link rel="icon" type="image/x-icon" href="./images/skohub-icon.png">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />

    <style>
      :root {
        --skoHubWhite: rgb(255, 255, 255);
        --skoHubDarkGreen: rgb(15, 85, 75);
        --skoHubMiddleGreen: rgb(20, 150, 140);
        --skoHubLightGreen: rgb(40, 200, 175);
        --skoHubThinGreen: rgb(55, 250, 210);
        --skoHubBlackGreen: rgb(5, 30, 30);
        --skoHubAction: rgb(230, 0, 125);
        --skoHubNotice: rgb(250, 180, 50);
        --skoHubDarkGrey: rgb(155, 155, 155);
        --skoHubMiddleGrey: rgb(200, 200, 200);
        --skoHubLightGrey: rgb(235, 235, 235);
      }

      /* ubuntu-regular - latin */
      @font-face {
        font-family: "Ubuntu";
        font-style: normal;
        font-weight: 400;
        src: local(""),
          url(./fonts/ubuntu-v20-latin-regular.woff2) format("woff2"),
          /* Super Modern Browsers */ url(./fonts/ubuntu-v20-latin-regular.woff)
            format("woff"),
          /* Modern Browsers */ url(./fonts/ubuntu-v20-latin-regular.ttf)
            format("truetype"); /* Safari, Android, iOS */
      }

      /* ubuntu-700 - latin */
      @font-face {
        font-family: "Ubuntu";
        font-style: normal;
        font-weight: 700;
        src: local(""), url(./fonts/ubuntu-v20-latin-700.woff2) format("woff2"),
          /* Super Modern Browsers */ url(./fonts/ubuntu-v20-latin-700.woff)
            format("woff"),
          /* Modern Browsers */ url(./fonts/ubuntu-v20-latin-700.ttf)
            format("truetype"); /* Safari, Android, iOS */
      }
      html,
      body {
        height: 100%; /* needed for proper layout */
      }
      html {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      *,
      *:before,
      *:after {
        -webkit-box-sizing: inherit;
        -moz-box-sizing: inherit;
        box-sizing: inherit;
      }

      body {
        padding: 0;
        margin: 0;
        border: 0 none;
        /* overflow: hidden; */
        background-color: var(--skoHubWhite);
        font-family: "Ubuntu", sans-serif;
        word-wrap: break-word;
        font-weight: 400;
        font-size: 16px;
        line-height: 20px;
        color: var(--skoHubDarkGreen);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        text-decoration: none;
        color: var(--skoHubDarkGreen);
      }

      a:hover {
        color: var(--skoHubAction);
      }

      .block {
        background-color: var(--skoHubWhite);
        box-shadow: 0 10px 20px 0 var(--skoHubMiddleGrey);
        padding: 30px;
        border-radius: 30px;
      }

      .wrapper {
        /* max-width: 1000px;
          margin: 0 auto;
          padding: 0 40px; */
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      main {
        padding: 20px;
        padding-top: 10px;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
      }

      #status {
        font-weight: bold;
      }

      h2 {
        display: inline-block;
      }

      #log,
      pre {
        word-wrap: break-word;
        white-space: pre-wrap;
        white-space: -moz-pre-wrap;
        white-space: -pre-wrap;
        white-space: -o-pre-wrap;
      }

      #log {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      #log li a {
        padding: 10px 20px;
        display: flex;
        align-items: center;
      }

      #log li:hover {
        background-color: var(--skoHubLightGrey);
      }

      #log li span:first-child {
        padding-right: 10px;
      }

      #log li:target {
        background-color: var(--skoHubThinGreen);
      }

      header {
        background: var(--skoHubWhite);
      }

      header h1 {
        margin: 0;
        display: inline-block;
      }

      header h1 a {
        color: var(--skoHubDarkGreen);
      }

      header .wave {
        overflow: hidden;
        position: relative;
        height: 50px;
      }

      header .headerContent {
        padding: 20px 20px 0px 20px;
        display: flex;
      }

      header h1 a:hover {
        color: var(--skoHubAction);
      }

      header .skohubLogo {
        margin: 0;
        display: inline-block;
        width: calc(100% - 80px);
      }

      header a {
        text-decoration: none;
        color: var(--skoHubDarkGreen);
      }

      header .skohubImg {
        display: inline-block;
        vertical-align: middle;
        width: 30px;
        height: 30px;
      }

      header .skohubTitle {
        display: inline-block;
        vertical-align: middle;
        padding: 0 0 0 15px;
        font-size: 24px;
        line-height: 24px;
        font-weight: 700;
      }

      #date {
        color: hsl(0, 0%, 54%);
      }

      .error {
        border: 4px solid tomato;
        border-radius: 8px;
        padding: 40px;
        margin-top: 50px;
        background-color: #fff;
        box-shadow: 0 2px 4px 0 rgba(14, 30, 37, 0.12);
      }

      .error h1 {
        color: tomato;
      }

      .metadata {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #status {
        text-transform: capitalize;
      }

      .warning {
        background-color: hsl(51, 100%, 93%);
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <div class="headerContent">
          <div class="skohubLogo">
            <a href="/">
              <img
                class="skohubImg"
                src="images/skohub-icon.png"
                alt="SkoHub"
              />
              <span class="skohubTitle">SkoHub-Log</span>
            </a>
          </div>
        </div>
      </header>

      <main>
        <div class="metadata">
          <div>
            <h2 id="status"></h2>
          </div>
          <span id="date"></span>
        </div>

        <h2>Payload</h2>
        <pre id="payload" class="block"></pre>

        <h2>Headers</h2>
        <pre id="headers" class="block"></pre>

        <h2>Deploy log</h2>
        <ul id="log" class="block"></ul>
      </main>
    </div>

    <script>
      const log = document.getElementById("log")
      const date = document.getElementById("date")
      const status = document.getElementById("status")
      const payload = document.getElementById("payload")
      const headers = document.getElementById("headers")

      const url = new URL(window.location.href)
      const id = url.searchParams.get("id")

      const setError = (msg) => {
        document.querySelector(".wrapper").innerHTML = `
          <main>
            <div class="error block">
              <h1>Error</h1>
              <p>${msg}</p>
            </div>
          </main>
          `
      }

      const getData = async () => {
        try {
          const response = await fetch(`./${id}.json`)
          const json = await response.json()
          renderData(json)
        } catch (error) {
          setTimeout(() => {
            console.warn("error", error)
            getData()
          }, 2000)
        }
      }

      const renderData = (json) => {
        payload.innerHTML = JSON.stringify(json.body, null, 2)
        date.innerHTML = new Date(json.date).toDateString()
        date.title = new Date(json.date).toISOString()
        headers.innerHTML = JSON.stringify(json.headers, null, 2)
        log.innerHTML = ""
        json.log.forEach((line, i) => {
          const li = document.createElement("li")
          const a = document.createElement("a")
          const logDate = document.createElement("span")
          const logText = document.createElement("text")
          li.id = i
          a.href = `#${i}`
          logDate.innerHTML = new Date(line.date)
            .toLocaleString()
            .split(", ")
            .slice(-1)
          logText.innerHTML = line.text
          if (line.warning) {
            li.classList.add("warning")
          }
          a.appendChild(logDate)
          a.appendChild(logText)
          li.appendChild(a)
          log.appendChild(li)
        })

        status.innerHTML = json.status
        if (json.status === "complete") {
          status.style.color = "MediumSeaGreen"
          const a = document.createElement("a")
          const span = document.createElement("span")
          span.innerHTML = " at "
          a.href = `/${json.repository}/${json.ref.replace("refs/", "")}/`
          a.innerHTML = `${json.repository}/${json.ref.replace("refs/", "")}/`

          status.parentNode.insertBefore(span, status.nextSibling)
          status.parentNode.insertBefore(a, span.nextSibling)
          status.appendChild
        } else if (json.status === "error") {
          status.style.color = "Tomato"
        } else {
          status.style.color = "gold"
        }

        if (json.status === "processing") {
          setTimeout(() => {
            console.log("process")
            getData()
          }, 2000)
        }
      }

      if (id) {
        getData()
      } else {
        setError("Build id is a required parameter")
      }
    </script>
  </body>
</html>
